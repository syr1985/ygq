//
//  NetWroking.m
//
//
//  Created by  on 14-8-11.
//  Copyright (c) 2014å¹´ . All rights reserved.
//

#import "NetWorking.h"
#import <AFNetworking.h>

#import "NSString+Encrypt.h"
#import "NSString+emoji.h"

//#ifdef DEBUG
//#define ServerUrl   @"http://121.40.159.39:8080/YGQ"
//#else
//#define ServerUrl   @"https://api.youguowang.com/YGQ"
//#endif

#define ServerUrl   @"http://121.40.159.39:8080/YGQ"//@"http://10.1.1.128:8080/YGQ"

#define EncryptCode @"newtouch"

@implementation NetWorking

#pragma mark -- åŠ å¯†

+ (NSString *)getMd5StringWithParameters:(NSMutableDictionary *)dict withPath:(NSString *)pathString {
    if (dict) {
        NSString *headString = [self getStringWithParameters:dict withSign:YES];
        NSString *signString = [headString stringByAppendingString:EncryptCode];
        NSString *signOfPath = [pathString stringByAppendingString:signString];
        //NSString *newString  = [NSString convertStringContainsEmoji:signOfPath];
        //NSString *bodyString = [signOfPath stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
        // ğŸ˜ƒ -> \Ud83d\Ude03
        //NSString *urlEncoded = [newString URLEncoding];
        NSString *urlEncoded = [[signOfPath MD5] uppercaseString];
        return urlEncoded;
    } else {
        return nil;
    }
}

+ (NSString *)getStringWithParameters:(NSMutableDictionary *)param withSign:(BOOL)bGetSign {
    NSArray *allKeys = [param allKeys];
    NSArray *sortArray = [allKeys sortedArrayUsingSelector:@selector(compare:)];
    NSString *paramString = @"";
    if (bGetSign) {
        for (NSString *key in sortArray) {
            if (![key isEqualToString:@"sign"]) {
                NSString *sectionString = [NSString stringWithFormat:@"%@=%@",key,[param objectForKey:key]];
                paramString = [paramString stringByAppendingString:sectionString];
            }
        }
    } else {
        for (NSString *key in sortArray) {
            NSString *sectionString = [NSString stringWithFormat:@"%@=%@&",key,[param objectForKey:key]];
            paramString = [paramString stringByAppendingString:sectionString];
        }
        paramString = [paramString substringToIndex:(paramString.length - 1)];
    }
    return paramString;
}

#pragma mark -- Session  AFN Post and Get
+ (void)postSessionWithUrl:(NSString *)urlStr parameters:(id)parameters success:(void (^)(id responseObject))success fail:(void (^)(NSError *error, NSString *msg))fail progress:(void (^)(float completed))progress {
    
    // 1.åˆ›å»ºAFNç®¡ç†è€…
    AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];
    manager.responseSerializer.acceptableContentTypes = [NSSet setWithArray:@[@"text/plain", @"text/html", @"application/json"]];
    
    // 2.ç”ŸæˆMD5åŠ å¯†ä¸²
    if (parameters) {
        NSString *md5String = [self getMd5StringWithParameters:parameters withPath:urlStr];
        parameters[@"sign"] = md5String;
    }
    
    // 3. ç»„åˆURL
    NSString *urlString = [NSString stringWithFormat:@"%@%@",ServerUrl,urlStr];
    
    // 4. è°ƒAFNçš„POSTæ–¹æ³•
    [manager POST:urlString parameters:parameters progress:^(NSProgress * _Nonnull uploadProgress) {
        if (progress) {
            float complete = (float)uploadProgress.completedUnitCount / uploadProgress.totalUnitCount;
            progress(complete);
        }
    }  success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
        NSString *result = [responseObject objectForKey:@"result"];
        
        NSDictionary *dict = @{@"001":@"ç­¾åé”™äº†",
                               @"002":@"ç³»ç»Ÿå¼€å°å·®äº†",
                               @"003":@"æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯",
                               @"004":@"è¯¥æ‰‹æœºå·ç å·²æ³¨å†Œ",
                               @"005":@"æ‰‹æœºå·æœªæ³¨å†Œ",
                               @"006":@"å‘é€çŸ­ä¿¡å¤±è´¥",
                               @"007":@"æ ¡éªŒå¤±è´¥",
                               @"008":@"ä¸šåŠ¡å‡ºé”™",
                               @"011":@"é‡‘é¢ä¸è¶³",
                               @"012":@"æ˜µç§°é‡å¤",
                               @"013":@"æç°æœåŠ¡ç°å·²å…³é—­ï¼Œæ¯å‘¨ä¸€å¼€æ”¾æç°åŠŸèƒ½"};
        
        NSString *msg = responseObject[@"msg"];
        NSArray *errorArray = [dict allKeys];
        if ([errorArray containsObject:result]) {
            if ([result isEqualToString:@"008"]) {
                if ([msg isEqualToString:@"dup"]) {
                    [SVProgressHUD showErrorWithStatus:@"æ‚¨å·²æ“ä½œè¿‡ï¼Œè¯·å‹¿é‡å¤æ“ä½œ"];
                } else if ([msg isEqualToString:@"block"]) {
                    [SVProgressHUD showErrorWithStatus:@"æ‚¨å·²è¢«å¯¹æ–¹å±è”½ï¼Œæ— æ³•æ“ä½œ"];
                } else if ([msg isEqualToString:@"error"] || [msg isEqualToString:@"delay"]) {
                    if (fail) {
                        fail(nil, msg);
                    }
                } else if ([msg isEqualToString:@"can not to myself"]) {
                    [SVProgressHUD showErrorWithStatus:@"æ— æ³•è‡ªå·±å…³æ³¨è‡ªå·±"];
                } else {
                    [SVProgressHUD showInfoWithStatus:responseObject[@"msg"]];
                }
            } else if ([result isEqualToString:@"011"]) {
                if (fail) {
                    fail(nil, dict[result]);
                }
            } else {
                [SVProgressHUD showInfoWithStatus:dict[result]];
            }
        } else {
            if (success) {
                success(responseObject);
            }
        }
    } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
        if (fail) {
            fail(error, nil);
        }
    }];
}

#pragma mark -- Session  AFN Post and Get
+ (void)postSessionWithUrl:(NSString *)urlStr parameters:(id)parameters images:(NSDictionary *)images success:(void (^)(id responseObject))success fail:(void (^)(NSError *error))fail progress:(void (^)(NSProgress *uploadProgress))progress {
    // 1.åˆ›å»ºAFNç®¡ç†è€…
    AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];
    manager.responseSerializer.acceptableContentTypes = [NSSet setWithArray:@[@"text/plain", @"text/html", @"application/json"]];
    
    // 2.
    if (parameters) {
        NSString *md5String = [self getMd5StringWithParameters:parameters withPath:urlStr];
        parameters[@"sign"] = md5String;
    }
    //    else {
    //        parameters = @{@"file":@""};
    //    }
    
    // 3. URL
    NSString *urlString = [NSString stringWithFormat:@"%@%@",ServerUrl,urlStr];
    
    [manager POST:urlString parameters:parameters constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData) {
        if (images) {
            NSArray *allkeys = images.allKeys;
            
            for (NSString *key in allkeys) {
                //è¦ä¸Šä¼ çš„å›¾ç‰‡
                UIImage *image = [images objectForKey:key];
                //å¾—åˆ°å›¾ç‰‡çš„data
                NSData *data = UIImageJPEGRepresentation(image, 0);
                
                NSString *fileName = [key stringByAppendingString:@".jpg"];
                [formData appendPartWithFileData:data name:@"file" fileName:fileName mimeType:@"image/jpg"];
            }
        }
    } progress:^(NSProgress * _Nonnull uploadProgress) {
        if (progress) {
            progress(uploadProgress);
        }
    } success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
        if (success) {
            success(responseObject);
        }
    } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
        if (fail) {
            fail(error);
        }
    }];
}

@end
